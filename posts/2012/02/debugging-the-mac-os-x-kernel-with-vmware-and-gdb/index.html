<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>ho.ax - Debugging the Mac OS X kernel with VMware and GDB</title>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/css/grid.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/css/style.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/css/highlight.css" media="screen">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://ho.ax/feed.xml">
  </head>
  <body>
      <div id="container">
        <div id="header">
          <div class="container_12">
            <div class="grid_6">
              <h1><a href="/">ho/ax.</a></h1>
            </div>
            <div class="grid_6">
              <div class="media">
                <div style="float: left"><a class="twitter" href="http://twitter.com/snare"></a></div>
                <div style="float: left"><a class="rss" href="/feed.xml"></a></div>
              </div>
            </div>
          </div>
        </div>
        <div id="splitbar">&nbsp;</div>
        <div id="main">
          <div class="container_12">
            <div class="grid_9">
              <div id="content">
                <h1><a href="/posts/2012/02/debugging-the-mac-os-x-kernel-with-vmware-and-gdb/">Debugging the Mac OS X kernel with VMware and GDB</a></h1>
<p class="metadata">
	Posted by snare on 14 February 2012. Tags: <a class="tag" href="/tag/mac os x/" rel="tag">mac os x</a>, <a class="tag" href="/tag/kernel/" rel="tag">kernel</a>, <a class="tag" href="/tag/debugging/" rel="tag">debugging</a>, <a class="tag" href="/tag/vmware/" rel="tag">vmware</a>, <a class="tag" href="/tag/gdb/" rel="tag">gdb</a>
</p>

<p><em>Edit 13 July 2013: I’ve made a couple of updates to this post to clarify a couple of things and resolve issues people have had.</em></p>

<p><em>fG! did a great write up <a href="http://reverse.put.as/2009/03/05/mac-os-x-kernel-debugging-with-vmware/">here</a> on how to set up two-machine debugging with VMware on Leopard a couple of years ago, but as a few things have changed since then and I will probably refer to this topic in future posts I thought it was worth revisiting.</em></p>

<p>Debugging kernel extensions can be a bit of a pain. <code>printf()</code>-debugging is the worst, and being in kernel-land, it might not be immediately obvious how to go about debugging your (or other people’s) code. Apple has long provided methods for <a href="https://developer.apple.com/library/mac/documentation/Darwin/Conceptual/KernelProgramming/build/build.html#//apple_ref/doc/uid/TP30000905-CH221-CIHBJCGC">kernel debugging</a> via the Kernel Debugger Protocol (KDP), along with <a href="https://developer.apple.com/library/mac/#documentation/Darwin/Conceptual/KernelProgramming/build/build.html%23//apple_ref/doc/uid/TP30000905-CH221-CIHDEDFH">ddb</a>, the in-kernel serial debugger. KDP is implemented in-kernel by an instance of <a href="https://developer.apple.com/library/mac/#documentation/Darwin/Reference/KernelIOKitFramework/IOKernelDebugger_h/Classes/IOKernelDebugger/index.html">IOKernelDebugger</a>, and allows you to connect to the debug stub from an instance of  <code>gdb</code> (Apple’s outdated fork only AFAIK) running on another machine connected via FireWire or Ethernet. <code>ddb</code> can be used to debug the running kernel from the target machine itself, but is pretty low-level and arcane. Apple suggests in the <a href="https://developer.apple.com/library/mac/#documentation/Darwin/Conceptual/KernelProgramming/build/build.html#//apple_ref/doc/uid/TP30000905-CH221-TPXREF111">Kernel Programming Guide</a> that you are better off using <code>gdb</code> for most tasks, so that’s what we’ll do.</p>

<h2 id="enter-vmware">Enter VMware</h2>

<p>We don’t really want to use two physical machines for debugging, because who the hell uses physical boxes these days when VMs will do the job? With the release of Mac OS X 10.7 (Lion), Apple changed the EULA to allow running virtualised instances of Lion on top of an instance running on bare metal. Prior to this, only the “server” version of Mac OS X was allowed to be virtualised, and VMware ‘prevented’ the client version from being installed through some hardcoded logic in <code>vmware-vmx</code> (which some sneaky hackers patched). VMware Fusion 4 introduced the ability to install Mac OS X 10.7 into a VM without any dodgy hacks, just by choosing the <em>Install Mac OS X Lion.app</em> bundle as the installation disc.</p>

<p>So, the first step of the process is: install yourself a Mac OS X VM as per the <a href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=2005334">VMware documentation</a>.</p>

<p><em>Edit 13 July 2013: Once you’re done it’s probably a good idea to take a snapshot of your VM in case there are problems installing the debug kernel. Generally it’s not a problem, but it’s annoying to roll back and much easier to use a VMware snapshot.</em></p>

<h2 id="install-the-debug-kernel">Install the debug kernel</h2>

<p>Once we’ve got our VM installed, we need to install the Kernel Debug Kit. This contains a version of the XNU kernel built with the <code>DEBUG</code> flag set, which includes the debug stubs for KDP and <code>ddb</code>, and a second <code>DEBUG</code> version with a full symbol table to load in GDB so we can use breakpoints on symbol names and not go insane. The debug kits used to live <a href="https://developer.apple.com/hardwaredrivers/download/kerneldebugkits.html">here</a>, but it seems Apple decided they only want ADC members to be able to access them, so now they’re <a href="https://developer.apple.com/downloads/index.action">here</a> (requires ADC login). Download the appropriate version for the target kernel you’re debugging in the VM (not necessarily the same as the kernel version on your host debugger machine). In this case I’m using <em>Kernel Debug Kit 10.7.3 build 11D50</em>. Copy this image up to the target VM, and install the debug kernel as per the instructions in the readme file:</p>

<pre><code>macvm$ sudo -s
macvm# cd /
macvm# ditto /Volumes/KernelDebugKit/DEBUG_Kernel/System.kext /System/Library/Extensions/System.kext
macvm# cp -r /Volumes/KernelDebugKit/DEBUG_Kernel/mach_kernel* /
macvm# chown -R root:wheel /System/Library/Extensions/System.kext /mach_kernel*
macvm# chmod -R g-w /System/Library/Extensions/System.kext /mach_kernel*
macvm# touch /System/Library/Extensions
macvm# shutdown -r now
</code></pre>

<p>Hopefully your VM has successfully booted with the debug kernel and no magic blue smoke has been let out.</p>

<p><em>Edit 13 July 2013: If your VM has panicked at boot time make sure you’ve allocated at least 4GB of RAM to the VM or it will not boot on newer OS X versions.</em></p>

<p>Next we need to set the kernel boot arguments to tell it to wait for a debugger connection at boot time. There are <a href="https://developer.apple.com/library/mac/#documentation/Darwin/Conceptual/KernelProgramming/build/build.html#//apple_ref/doc/uid/TP30000905-CH221-TPXREF111">other options</a> but, as fG! said previously, there isn’t an obvious way to generate an NMI within VMware (I haven’t really looked further into this - if there is I’d like to hear about it). In VMware Fusion 4, the proper NVRAM support means we can specify normal <code>boot-args</code> in NVRAM rather than the old <code>com.apple.Boot.plist</code>, by using the <code>nvram</code> utility on the target VM like this:</p>

<pre><code>macvm# nvram boot-args="-v debug=0x1"
</code></pre>

<p>Now we’ll do a bit of config on the debug host, then reboot the VM.</p>

<h2 id="debug-host-config">Debug host config</h2>

<p>Traditionally, two-machine debugging would either use FireWire or Ethernet. We can simulate Ethernet with the VMware network bridging.</p>

<p><em>Edit 13 July 2013: With newer versions of OS X (I’m not sure exactly when they introduced this but it definitely works on 10.8.4) you don’t actually need to do this static ARP trick any more. When the VM boots it will stop at “Waiting for remote debugger connection” after telling you its MAC and IP address. You should be able to skip the static ARP and just <code>kdp-reattach</code> (as below) directly to the IP address displayed here.</em></p>

<p>Grab the MAC address and IP address of your VM:</p>

<pre><code>macvm$ ifconfig en0
en0: flags=8863&lt;UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
	options=2b&lt;RXCSUM,TXCSUM,VLAN_HWTAGGING,TSO4&gt;
	ether 00:0c:29:d6:df:02 
	inet6 fe80::20c:29ff:fed6:df02%en0 prefixlen 64 scopeid 0x4 
	inet 10.0.0.15 netmask 0xffffff00 broadcast 10.0.0.255
	media: autoselect (1000baseT &lt;full-duplex&gt;)
	status: active
</code></pre>

<p>And back on your debug host, add a static ARP entry for the VM:</p>

<pre><code>debughost# arp -s 10.0.0.15 0:c:29:d6:df:2
debughost# arp 10.0.0.15
macvm (10.0.0.15) at 0:c:29:d6:df:2 on en0 permanent [ethernet]
</code></pre>

<p>I also have an <code>/etc/hosts</code> entry for the VM, hence the hostname <code>macvm</code>.</p>

<p>Now we should be able to reboot the VM and it will pause waiting for the debugger connection at the start of the boot process. It used to actually say <em>Waiting for debugger connection…</em> or something similar in previous kernel versions, but it seems to pause after <em>[PCI configuration begin]</em> on 10.7.</p>

<h2 id="fire-up-gdb">Fire up GDB</h2>

<p>Now it’s time to actually start GDB and connect to the KDP debug stub. Assuming you’ve just mounted the Kernel Debug Kit dmg file, the following paths should be correct. On the debug host machine:</p>

<pre><code class="language-gdb">$ gdb /Volumes/KernelDebugKit/DEBUG_Kernel/mach_kernel
GNU gdb <span class="mh">6</span>.<span class="mh">3</span>.<span class="mh">50</span>-<span class="mh">20050815</span> (Apple version gdb-<span class="mh">1708</span>) (Thu Nov  <span class="mh">3</span> <span class="mh">21</span>:<span class="mh">59</span>:<span class="mh">02</span> UTC <span class="mh">2011</span>)
Copyright <span class="mh">2004</span> Free Software Foundation, Inc.
GDB is free software, covered by the GNU General Public License, and you are
welcome to change it and/or distribute copies of it under certain conditions.
Type <span class="s">"show copying"</span> to see the conditions.
There is absolutely no warranty for GDB.  Type <span class="s">"show warranty"</span> for details.
This GDB was configured as <span class="s">"x86_64-apple-darwin"</span>...</code></pre>

<p>This is contrary to the instructions in the readme file for the Kernel Debug Kit, which tells you to target <code>/Volumes/KernelDebugKit/mach_kernel</code> with <code>gdb</code>. I haven’t been able to get this kernel to work correctly - symbols are not looked up properly and lots of addresses seem to be wrong, resulting in the <code>kgmacros</code> stuff not working, and breakpoints being set at the wrong addresses. If you load the kernel in the <code>DEBUG_Kernel</code> directory it works OK.</p>

<p>Next, source the <code>kgmacros</code> file - this contains a bunch of GDB macros that make dealing with kernel introspection and debugging much easier (particularly when you want to start looking at stuff like the virtual memory subsystem, and other fun stuff):</p>

<pre><code class="language-gdb"><span class="kt">gdb$</span> <span class="nb">source</span> /Volumes/KernelDebugKit/kgmacros 
Loading Kernel GDB Macros package.  Type <span class="s">"help kgm"</span> for more info.</code></pre>

<p>Note: if you’re attaching to a kernel running on a different arch (ie. you created a 32-bit VM on a 64-bit machine), you’ll need to use the <code>--arch</code> flag:</p>

<blockquote>
  <p>The –arch=i386 option allows you to use a system running the 64-bit kernel to connect to a target running the 32-bit kernel. The –arch=x86_64 option allows you to go the other direction.</p>
</blockquote>

<p>Now we attach to the debug target machine:</p>

<pre><code class="language-gdb"><span class="kt">gdb$</span> <span class="nb">kdp</span>-reattach <span class="mh">10</span>.<span class="mh">0</span>.<span class="mh">0</span>.<span class="mh">15</span>
Connected.</code></pre>

<p><em>Edit 13 July 2013: If you’re using a recent OS X you can <code>kdp-reattach</code> to the IP address that was printed when the debug kernel paused waiting for the debugger.</em></p>

<p>You can also attach using <code>target remote-kdp</code> and <code>attach 10.0.0.15</code>. Allow the kernel to continue execution:</p>

<pre><code class="language-gdb"><span class="kt">gdb$</span> <span class="nb">c</span></code></pre>

<p>At this point the disk icon in VMware should be going blue with activity, and the VM should continue booting as normal.</p>

<h2 id="breaking-into-the-debugger">Breaking into the debugger</h2>

<p>Unfortunately, we can’t use the normal method of hitting <code>^C</code> in the debugger to pause execution, so we have to rely on software breakpoints. The method fG! initially suggested was to break on <code>tcp_connect()</code> or something similar, so you can drop into the debugger by attempting to <code>telnet</code> somewhere. This proves to be a bit cumbersome in Lion with all the fancy (scary) network autodetect stuff - connections going out from agents all over the place means constantly dropping into the debugger.</p>

<p>The method that I have primarily used is to set a breakpoint on the <code>kext_alloc()</code> function. This is called once during the initialisation of a kernel extension, so it can be a reasonably useful point at which to break if you want to debug the initialisation of the kext, and a good on-demand breakpoint for general kernel memory inspection.</p>

<p><em>Edit 13 July 2013: @chicagoben pointed me at a simple method of replicating the behaviour of an NMI and dropping into the debugger using the technique in <a href="https://github.com/shiro-t/PseudoNMI">this handy kernel module</a>.</em></p>

<p>Breaking on <code>kext_alloc()</code>:</p>

<pre><code class="language-gdb">Breakpoint <span class="mh">1</span>, kext_alloc (_addr<span class="o">=</span><span class="mh">0xffffff804650b5f0</span>, size<span class="o">=</span><span class="mh">0x3000</span>, fixed<span class="o">=</span><span class="mh">0x0</span>) at kext_alloc.c:<span class="mh">107</span>
<span class="mh">107</span>	in kext_alloc.c</code></pre>

<p>And getting a stack trace:</p>

<pre><code class="language-gdb"><span class="kt">gdb$</span> <span class="nb">bt</span>
#<span class="mh">0</span>  kext_alloc (_addr<span class="o">=</span><span class="mh">0xffffff804650b5f0</span>, size<span class="o">=</span><span class="mh">0x3000</span>, fixed<span class="o">=</span><span class="mh">0x0</span>) at kext_alloc.c:<span class="mh">107</span>
#<span class="mh">1</span>  <span class="mh">0xffffff80008f4166</span> in kern_allocate (size<span class="o">=</span><span class="mh">0x3000</span>, flags<span class="o">=</span><span class="mh">0xffffff804650b664</span>, user_data<span class="o">=</span><span class="mh">0xffffff80096f9880</span>) at OSKext.cpp:<span class="mh">408</span>
#<span class="mh">2</span>  <span class="mh">0xffffff8000922874</span> in allocate_kext (context<span class="o">=</span><span class="mh">0xffffff800af06420</span>, callback_data<span class="o">=</span><span class="mh">0xffffff80096f9880</span>, vmaddr_out<span class="o">=</span><span class="mh">0xffffff804650b710</span>, vmsize_out<span class="o">=</span><span class="mh">0xffffff804650b708</span>, linked_object_alloc_out<span class="o">=</span><span class="mh">0xffffff804650b6f8</span>) at kxld.c:<span class="mh">468</span>
#<span class="mh">3</span>  <span class="mh">0xffffff8000921e69</span> in kxld_link_file (context<span class="o">=</span><span class="mh">0xffffff800af06420</span>, file<span class="o">=</span><span class="mh">0xffffff8036641000</span> <span class="s">"????\a"</span>, size<span class="o">=</span><span class="mh">0x2600</span>, name<span class="o">=</span><span class="mh">0xffffff8007e14a90</span> <span class="s">"ax.ho.kext.DebugTest"</span>, callback_data<span class="o">=</span><span class="mh">0xffffff80096f9880</span>, dependencies<span class="o">=</span><span class="mh">0xffffff80091e4a60</span>, ndependencies<span class="o">=</span><span class="mh">0x6</span>, linked_object_out<span class="o">=</span><span class="mh">0xffffff804650b8f8</span>, kmod_info_kern<span class="o">=</span><span class="mh">0xffffff80096f98c8</span>) at kxld.c:<span class="mh">273</span>
#<span class="mh">4</span>  <span class="mh">0xffffff80008f0b55</span> in OSKext::loadExecutable (this<span class="o">=</span><span class="mh">0xffffff80096f9880</span>) at OSKext.cpp:<span class="mh">4751</span>
#<span class="mh">5</span>  <span class="mh">0xffffff80008f3cc4</span> in OSKext::load (this<span class="o">=</span><span class="mh">0xffffff80096f9880</span>, startOpt<span class="o">=</span><span class="mh">0x0</span>, startMatchingOpt<span class="o">=</span><span class="mh">0x0</span>, personalityNames<span class="o">=</span><span class="mh">0x0</span>) at OSKext.cpp:<span class="mh">4420</span>
#<span class="mh">6</span>  <span class="mh">0xffffff80008f741b</span> in OSKext::loadKextWithIdentifier (kextIdentifier<span class="o">=</span><span class="mh">0xffffff8007e1adf0</span>, allowDeferFlag<span class="o">=</span><span class="mh">0x0</span>, delayAutounloadFlag<span class="o">=</span><span class="mh">0x0</span>, startOpt<span class="o">=</span><span class="mh">0x0</span>, startMatchingOpt<span class="o">=</span><span class="mh">0x0</span>, personalityNames<span class="o">=</span><span class="mh">0x0</span>) at OSKext.cpp:<span class="mh">4184</span>
#<span class="mh">7</span>  <span class="mh">0xffffff80008f8c91</span> in OSKext::loadFromMkext (clientLogFilter<span class="o">=</span><span class="mh">0x0</span>, mkextBuffer<span class="o">=</span><span class="mh">0xffffff8046362400</span> <span class="s">"MKXTMOSX"</span>, mkextBufferLength<span class="o">=</span><span class="mh">0x2da8</span>, logInfoOut<span class="o">=</span><span class="mh">0xffffff804650bc30</span>, logInfoLengthOut<span class="o">=</span><span class="mh">0xffffff804650bc2c</span>) at OSKext.cpp:<span class="mh">3271</span>
#<span class="mh">8</span>  <span class="mh">0xffffff8000909f32</span> in kext_request (hostPriv<span class="o">=</span><span class="mh">0xffffff8000c8bec0</span>, clientLogSpec<span class="o">=</span><span class="mh">0x0</span>, requestIn<span class="o">=</span><span class="mh">0xffffff80075c9d30</span>, requestLengthIn<span class="o">=</span><span class="mh">0x2da8</span>, responseOut<span class="o">=</span><span class="mh">0xffffff800a976918</span>, responseLengthOut<span class="o">=</span><span class="mh">0xffffff800a976940</span>, logDataOut<span class="o">=</span><span class="mh">0xffffff800a976928</span>, logDataLengthOut<span class="o">=</span><span class="mh">0xffffff800a976944</span>, op_result<span class="o">=</span><span class="mh">0xffffff800a976948</span>) at OSKextLib.cpp:<span class="mh">281</span>
#<span class="mh">9</span>  <span class="mh">0xffffff800028d9ab</span> in _Xkext_request (InHeadP<span class="o">=</span><span class="mh">0xffffff800abbec38</span>, OutHeadP<span class="o">=</span><span class="mh">0xffffff800a9768f4</span>) at host_priv_server.c:<span class="mh">5961</span>
#<span class="mh">10</span> <span class="mh">0xffffff80002443d2</span> in ipc_kobject_server (request<span class="o">=</span><span class="mh">0xffffff800abbebc0</span>) at ipc_kobject.c:<span class="mh">339</span>
#<span class="mh">11</span> <span class="mh">0xffffff8000221570</span> in ipc_kmsg_send (kmsg<span class="o">=</span><span class="mh">0xffffff800abbebc0</span>, option<span class="o">=</span><span class="mh">0x0</span>, send_timeout<span class="o">=</span><span class="mh">0x0</span>) at ipc_kmsg.c:<span class="mh">1376</span>
#<span class="mh">12</span> <span class="mh">0xffffff8000237393</span> in mach_msg_overwrite_trap (args<span class="o">=</span><span class="mh">0xffffff80067c65a4</span>) at mach_msg.c:<span class="mh">487</span>
#<span class="mh">13</span> <span class="mh">0xffffff80002375b4</span> in mach_msg_trap (args<span class="o">=</span><span class="mh">0xffffff80067c65a4</span>) at mach_msg.c:<span class="mh">554</span>
#<span class="mh">14</span> <span class="mh">0xffffff8000354a01</span> in mach_call_munger<span class="mh">64</span> (state<span class="o">=</span><span class="mh">0xffffff80067c65a0</span>) at bsd_i<span class="mh">386</span>.c:<span class="mh">534</span></code></pre>

<p>If you’re debugging a kernel extension that you are writing yourself (or have the code for) a better method of dropping into the debugger is to put an <code>int 3</code> (software breakpoint) in your code at the point you want to break, like this:</p>

<pre><code class="language-c"><span class="n">kern_return_t</span> <span class="nf">DebugTest_start</span><span class="p">(</span><span class="n">kmod_info_t</span> <span class="o">*</span> <span class="n">ki</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"hurr</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">asm</span><span class="p">(</span><span class="s">"int $3"</span><span class="p">);</span>
    <span class="n">derp</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">KERN_SUCCESS</span><span class="p">;</span>
<span class="p">}</span></code></pre>

<p>Now when we load this kext we get dropped into the debugger:</p>

<pre><code class="language-gdb">Program received signal SIGTRAP, Trace/breakpoint trap.
<span class="mh">0xffffff7f80b2af12</span> in ?? ()</code></pre>

<p>The call stack at this point looks somewhat similar to before, passing through the <code>OSKext</code> class:</p>

<pre><code class="language-gdb"><span class="kt">gdb$</span> <span class="nb">bt</span>
#<span class="mh">0</span>  <span class="mh">0xffffff7f80b27f12</span> in ?? ()
#<span class="mh">1</span>  <span class="mh">0xffffff80008eebb4</span> in OSKext::start (this<span class="o">=</span><span class="mh">0xffffff8007d37400</span>, startDependenciesFlag<span class="o">=</span><span class="mh">0x1</span>) at OSKext.cpp:<span class="mh">5456</span>
#<span class="mh">2</span>  <span class="mh">0xffffff80008f3e97</span> in OSKext::load (this<span class="o">=</span><span class="mh">0xffffff8007d37400</span>, startOpt<span class="o">=</span><span class="mh">0x0</span>, startMatchingOpt<span class="o">=</span><span class="mh">0x0</span>, personalityNames<span class="o">=</span><span class="mh">0x0</span>) at OSKext.cpp:<span class="mh">4475</span>
#<span class="mh">3</span>  <span class="mh">0xffffff80008f741b</span> in OSKext::loadKextWithIdentifier (kextIdentifier<span class="o">=</span><span class="mh">0xffffff80068955b0</span>, allowDeferFlag<span class="o">=</span><span class="mh">0x0</span>, delayAutounloadFlag<span class="o">=</span><span class="mh">0x0</span>, startOpt<span class="o">=</span><span class="mh">0x0</span>, startMatchingOpt<span class="o">=</span><span class="mh">0x0</span>, personalityNames<span class="o">=</span><span class="mh">0x0</span>) at OSKext.cpp:<span class="mh">4184</span>
#<span class="mh">4</span>  <span class="mh">0xffffff80008f8c91</span> in OSKext::loadFromMkext (clientLogFilter<span class="o">=</span><span class="mh">0x0</span>, mkextBuffer<span class="o">=</span><span class="mh">0xffffff804623e400</span> <span class="s">"MKXTMOSX"</span>, mkextBufferLength<span class="o">=</span><span class="mh">0x2da8</span>, logInfoOut<span class="o">=</span><span class="mh">0xffffff8045c23c30</span>, logInfoLengthOut<span class="o">=</span><span class="mh">0xffffff8045c23c2c</span>) at OSKext.cpp:<span class="mh">3271</span>
<span class="cs">&lt;snip&gt;</span></code></pre>

<p>And we can disassemble the code at and after the breakpoint:</p>

<pre><code class="language-gdb"><span class="kt">gdb$</span> <span class="nb">x</span>/<span class="mi">11</span><span class="kc">i</span> <span class="mh">0xffffff7f80b2df12</span> - <span class="mh">1</span>
<span class="mh">0xffffff7f80b2df11</span>:	int<span class="mh">3</span>   
<span class="mh">0xffffff7f80b2df12</span>:	xor    cl,cl
<span class="mh">0xffffff7f80b2df14</span>:	mov    al,cl
<span class="mh">0xffffff7f80b2df16</span>:	call   <span class="mh">0xffffff7f80b2df70</span>
<span class="mh">0xffffff7f80b2df1b</span>:	mov    DWORD PTR [rbp-<span class="mh">0x18</span>],<span class="mh">0x0</span>
<span class="mh">0xffffff7f80b2df22</span>:	mov    eax,DWORD PTR [rbp-<span class="mh">0x18</span>]
<span class="mh">0xffffff7f80b2df25</span>:	mov    DWORD PTR [rbp-<span class="mh">0x14</span>],eax
<span class="mh">0xffffff7f80b2df28</span>:	mov    eax,DWORD PTR [rbp-<span class="mh">0x14</span>]
<span class="mh">0xffffff7f80b2df2b</span>:	add    rsp,<span class="mh">0x20</span>
<span class="mh">0xffffff7f80b2df2f</span>:	pop    rbp
<span class="mh">0xffffff7f80b2df30</span>:	ret</code></pre>

<p>This corresponds to the following code from the binary (extracted using <code>otool -tv</code>):</p>

<pre><code class="language-s"><span class="m">0000000000000</span>f11	int	<span class="p">$</span><span class="m">0</span>x3
<span class="m">0000000000000</span>f12	xorb	<span class="o">%</span>cl<span class="p">,</span><span class="o">%</span>cl
<span class="m">0000000000000</span>f14	movb	<span class="o">%</span>cl<span class="p">,</span><span class="o">%</span>al
<span class="m">0000000000000</span>f16	callq	<span class="m">0</span>x00000f70
<span class="m">0000000000000</span>f1b	movl	<span class="p">$</span><span class="m">0</span>x00000000<span class="p">,</span><span class="m">0</span>xe8<span class="p">(</span><span class="o">%</span>rbp<span class="p">)</span>
<span class="m">0000000000000</span>f22	movl	<span class="m">0</span>xe8<span class="p">(</span><span class="o">%</span>rbp<span class="p">),</span><span class="o">%</span>eax
<span class="m">0000000000000</span>f25	movl	<span class="o">%</span>eax<span class="p">,</span><span class="m">0</span>xec<span class="p">(</span><span class="o">%</span>rbp<span class="p">)</span>
<span class="m">0000000000000</span>f28	movl	<span class="m">0</span>xec<span class="p">(</span><span class="o">%</span>rbp<span class="p">),</span><span class="o">%</span>eax
<span class="m">0000000000000</span>f2b	addq	<span class="p">$</span><span class="m">0</span>x20<span class="p">,</span><span class="o">%</span>rsp
<span class="m">0000000000000</span>f2f	popq	<span class="o">%</span>rbp
<span class="m">0000000000000</span>f30	ret</code></pre>

<h2 id="poking-around-in-kernel-memory">Poking around in kernel memory</h2>

<p>Let’s check out a few neat things in memory. The start of the Mach-O header for the kernel image in memory:</p>

<pre><code class="language-gdb"><span class="kt">gdb$</span> <span class="nb">x</span>/<span class="kc">x</span> <span class="mh">0xffffff8000200000</span>
<span class="mh">0xffffff8000200000</span>:	<span class="mh">0xfeedfacf</span></code></pre>

<p>This is the “magic number” indicating a 64-bit Mach-O executable. The 32-bit version is <code>0xfeedface</code>.</p>

<p>The “system verification code”:</p>

<pre><code class="language-gdb"><span class="kt">gdb$</span> <span class="nb">x</span>/<span class="kc">s</span> <span class="mh">0xffffff8000002000</span>
<span class="mh">0xffffff8000002000</span>:	 <span class="s">"Catfish "</span></code></pre>

<p>On previous PowerPC versions of the OS this was located at <code>0x5000</code> and said <code>"Hagfish "</code>. Here is the corresponding assembly source from <code>osfmk/x86_64/lowmem_vectors.s</code> in the kernel source tree:</p>

<pre><code class="language-s"><span class="o">/*</span> 
 <span class="o">*</span> on x86_64 the low mem vectors live here and get mapped to <span class="m">0</span>xffffff8000200000 at
 <span class="o">*</span> system startup time
 <span class="o">*/</span>

	<span class="m">.</span>text
	<span class="m">.</span>align	<span class="m">12</span>
	<span class="m">.</span>globl	EXT<span class="p">(</span>lowGlo<span class="p">)</span>
EXT<span class="p">(</span>lowGlo<span class="p">)</span>:

	<span class="m">.</span>ascii <span class="s">"Catfish "</span>	<span class="o">/*</span> <span class="m">+0</span>x000 System verification code <span class="o">*/</span></code></pre>

<p>Interestingly, that comment appears to be incorrect - <code>0xffffff8000200000</code> is where the kernel image itself starts and the stuff in <code>lowmem_vectors.s</code> starts at <code>0xffffff8000002000</code> as we’ve seen.</p>

<p>If you’re interested in kernel internals (which you probably are if you’re reading this) then you might want to have a look at the <code>kgmacros</code> help at this point:</p>

<pre><code class="language-gdb"><span class="kt">gdb$</span> <span class="nb">help</span> kgm
| These are the kernel gdb macros.  These gdb macros are intended to be
| used when debugging a remote kernel via the kdp protocol.  Typically, you
| would connect to your remote target like so:
| 		 <span class="kt">(gdb)</span> <span class="nb">target</span> remote-kdp
| 		 <span class="kt">(gdb)</span> <span class="nb">attach</span> &lt;name-of-remote-host&gt;
<span class="cs">&lt;snip&gt;</span></code></pre>

<p>There’s heaps of cool and useful stuff there to look at.</p>

<p>Listing the process tree by walking the list from <code>allproc</code> down:</p>

<pre><code class="language-gdb"><span class="kt">gdb$</span> <span class="nb">showproctree</span>
PID   PROCESS       POINTER]
<span class="o">===</span>   <span class="o">=======</span>       <span class="o">=======</span>
<span class="mh">0</span>    kernel_task      [ <span class="mh">0xffffff80073e8820</span> ]
|--<span class="mh">1</span>    launchd      [ <span class="mh">0xffffff80073e8820</span> ]
|  |--<span class="mh">163</span>    xpchelper      [ <span class="mh">0xffffff800912a9f0</span> ] 
|  |--<span class="mh">158</span>    launchd    [ <span class="mh">0xffffff8007c65e40</span> ]
|  |  |--<span class="mh">162</span>    distnoted      [ <span class="mh">0xffffff80081f8010</span> ] 
|  |  |--<span class="mh">161</span>    mdworker    [ <span class="mh">0xffffff80073e83d0</span> ]
|  |--<span class="mh">157</span>    mdworker    [ <span class="mh">0xffffff80082c6010</span> ]
|  |--<span class="mh">139</span>    com.apple.dock.e    [ <span class="mh">0xffffff800912ae40</span> ]
|  |--<span class="mh">138</span>    filecoordination    [ <span class="mh">0xffffff800912b290</span> ]
|  |--<span class="mh">111</span>    xpchelper    [ <span class="mh">0xffffff8007c66f80</span> ]
|  |--<span class="mh">106</span>    launchdadd    [ <span class="mh">0xffffff80081fa290</span> ]
|  |--<span class="mh">104</span>    launchd    [ <span class="mh">0xffffff80082c86e0</span> ]
<span class="cs">&lt;snip&gt;</span></code></pre>

<p>Print the <code>struct proc</code> (kernel version, not the userland one) for the kernel task:</p>

<pre><code class="language-gdb"><span class="kt">gdb$</span> <span class="nb">print</span> *(<span class="kt">struct proc *</span>)<span class="mh">0xffffff80073e8820</span>
<span class="nv">$4</span> = {
  <span class="nv">p_list</span> = {
    <span class="nv">le_next</span> = <span class="mh">0xffffff8000cb4c20</span>, 
    <span class="nv">le_prev</span> = <span class="mh">0xffffff80073e76e0</span>
  }, 
  <span class="nv">p_pid</span> = <span class="mh">0x1</span>, 
  <span class="nv">task</span> = <span class="mh">0xffffff80067c25a0</span>, 
  <span class="nv">p_pptr</span> = <span class="mh">0xffffff8000cb4c20</span>, 
  <span class="nv">p_ppid</span> = <span class="mh">0x0</span>, 
  <span class="nv">p_pgrpid</span> = <span class="mh">0x1</span>, 
  <span class="nv">p_uid</span> = <span class="mh">0x0</span>, 
  <span class="nv">p_gid</span> = <span class="mh">0x0</span>, 
  <span class="cs">&lt;snip&gt;</span></code></pre>

<p>Have a poke around and see what you can find.</p>

<h2 id="source-level-debugging">Source-level debugging</h2>

<p>Now that we’ve explored kernel memory a bit, it’s probably worth noting that you can use the kernel source for source-level debugging within GDB, or possibly even in Xcode (anybody done this?). Some of the documentation seems to be a bit out of date on this - e.g. the Kernel Programming Guide references a <code>.gdbinit</code> file defined in the <code>osfmk</code> directory (the Mach part of the kernel) which no longer exists, and previous documentation mentions creation of a <code>/SourceCache/xnu/...</code> directory for source-level debugging, but this trick doesn’t seem to work any more. It seems that these days the kernel debug symbol information relates only to filename and line number, not full file path, like this:</p>

<pre><code class="language-gdb">Breakpoint <span class="mh">1</span>, kext_alloc (_addr<span class="o">=</span><span class="mh">0xffffff80463735f0</span>, size<span class="o">=</span><span class="mh">0x3000</span>, fixed<span class="o">=</span><span class="mh">0x0</span>) at kext_alloc.c:<span class="mh">107</span>
<span class="mh">107</span>	kext_alloc.c: No such file or directory.</code></pre>

<p>We can still load source code on a per-directory basis if we know where the file in question is located. In this instance it’s <code>osfmk/kern/kext_alloc.c</code> within the kernel source tree, we’ll do this:</p>

<pre><code class="language-gdb"><span class="kt">gdb$</span> <span class="nb">dir</span> /path/to/xnu-<span class="mh">1699</span>.<span class="mh">24</span>.<span class="mh">23</span>/osfmk/kern/</code></pre>

<p>And magic:</p>

<pre><code class="language-gdb"><span class="kt">gdb$</span> <span class="nb">l</span>
<span class="mh">102</span>	}
<span class="mh">103</span>	
<span class="mh">104</span>	kern_return_t
<span class="mh">105</span>	kext_alloc(vm_offset_t *_addr, vm_size_t size, boolean_t fixed)
<span class="mh">106</span>	{
<span class="mh">107</span>	    kern_return_t rval <span class="o">=</span> <span class="mh">0</span>;
<span class="mh">108</span>	    mach_vm_offset_t addr <span class="o">=</span> (fixed) ? *_addr : kext_alloc_base;
<span class="mh">109</span>	    int flags <span class="o">=</span> (fixed) ? VM_FLAGS_FIXED : VM_FLAGS_ANYWHERE;
<span class="mh">110</span>	 
<span class="mh">111</span>	    /* Allocate the kext virtual memory */</code></pre>

<p>Go grab yourself a copy of the source for your kernel version at <a href="http://www.opensource.apple.com/">opensource.apple.com</a> and give it a try.</p>

<h2 id="so-yeah">So, yeah…</h2>

<p>Have fun.</p>


              </div>
            </div>
            <div class="grid_3">
              <div id="sidebar">
                <h2>PAGES</h2>
                <ul>
                  <li><a href="/">Home</a></li>
                  <li><a href="/about">About</a></li>
                  <li><a href="/downloads">Downloads</a></li>
                </ul>
                <h2>TAGS</h2>
                <p><a class="tagcloud" style="font-size:78.23529411764706%;" href="/tag/voltron/" rel="tag">voltron</a> <a class="tagcloud" style="font-size:85.29411764705883%;" href="/tag/debugging/" rel="tag">debugging</a> <a class="tagcloud" style="font-size:85.29411764705883%;" href="/tag/gdb/" rel="tag">gdb</a> <a class="tagcloud" style="font-size:64.11764705882352%;" href="/tag/lldb/" rel="tag">lldb</a> <a class="tagcloud" style="font-size:57.05882352941176%;" href="/tag/calculon/" rel="tag">calculon</a> <a class="tagcloud" style="font-size:120.58823529411765%;" href="/tag/efi/" rel="tag">efi</a> <a class="tagcloud" style="font-size:71.17647058823529%;" href="/tag/ida pro/" rel="tag">ida pro</a> <a class="tagcloud" style="font-size:64.11764705882352%;" href="/tag/idapython/" rel="tag">idapython</a> <a class="tagcloud" style="font-size:64.11764705882352%;" href="/tag/reversing/" rel="tag">reversing</a> <a class="tagcloud" style="font-size:85.29411764705883%;" href="/tag/rootkits/" rel="tag">rootkits</a> <a class="tagcloud" style="font-size:57.05882352941176%;" href="/tag/refind/" rel="tag">refind</a> <a class="tagcloud" style="font-size:57.05882352941176%;" href="/tag/black hat/" rel="tag">black hat</a> <a class="tagcloud" style="font-size:57.05882352941176%;" href="/tag/firmware/" rel="tag">firmware</a> <a class="tagcloud" style="font-size:57.05882352941176%;" href="/tag/bus pirate/" rel="tag">bus pirate</a> <a class="tagcloud" style="font-size:57.05882352941176%;" href="/tag/flashrom/" rel="tag">flashrom</a> <a class="tagcloud" style="font-size:57.05882352941176%;" href="/tag/pci/" rel="tag">pci</a> <a class="tagcloud" style="font-size:57.05882352941176%;" href="/tag/syscan/" rel="tag">syscan</a> <a class="tagcloud" style="font-size:78.23529411764706%;" href="/tag/mac os x/" rel="tag">mac os x</a> <a class="tagcloud" style="font-size:57.05882352941176%;" href="/tag/x86-64/" rel="tag">x86-64</a> <a class="tagcloud" style="font-size:57.05882352941176%;" href="/tag/clang/" rel="tag">clang</a> <a class="tagcloud" style="font-size:71.17647058823529%;" href="/tag/kernel/" rel="tag">kernel</a> <a class="tagcloud" style="font-size:57.05882352941176%;" href="/tag/kexts/" rel="tag">kexts</a> <a class="tagcloud" style="font-size:57.05882352941176%;" href="/tag/mach-o/" rel="tag">mach-o</a> <a class="tagcloud" style="font-size:57.05882352941176%;" href="/tag/python/" rel="tag">python</a> <a class="tagcloud" style="font-size:64.11764705882352%;" href="/tag/vmware/" rel="tag">vmware</a> </p>
                <h2>POSTS</h2>
                <ul>
                  
                    <li><a href="/posts/2015/05/building-voltron-command-plugins/">Building Voltron Command Plugins</a></li>
                  
                    <li><a href="/posts/2014/12/building-voltron-views/">Building Voltron Views</a></li>
                  
                    <li><a href="/posts/2013/10/calculon-a-calculator-for-nerds/">Calculon - a calculator for nerds</a></li>
                  
                    <li><a href="/posts/2013/06/voltron-a-hacky-ui-for-gdb/">Voltron - a hacky UI for GDB</a></li>
                  
                    <li><a href="/posts/2012/12/te-loader-for-ida-pro/">TE loader for IDA Pro</a></li>
                  
                    <li><a href="/posts/2012/10/ruxcon/">Ruxcon 2012</a></li>
                  
                    <li><a href="/posts/2012/09/ida-pro-scripts-for-efi-reversing/">IDA Pro scripts for EFI reversing</a></li>
                  
                    <li><a href="/posts/2012/08/building-refind-with-edk2-on-osx/">Building rEFInd with EDKII on Mac OS X</a></li>
                  
                    <li><a href="/posts/2012/07/black-hat-usa-2012/">Black Hat USA 2012</a></li>
                  
                    <li><a href="/posts/2012/06/unbricking-a-macbook/">Un-bricking a MacBook</a></li>
                  
                    <li><a href="/posts/2012/06/send-me-your-lspci/">Send me your `lspci -vv`</a></li>
                  
                    <li><a href="/posts/2012/05/syscan-2012-is-over/">SyScan 2012 is Over</a></li>
                  
                    <li><a href="/posts/2012/03/rip-relative-addressing-and-kernel-payloads/">RIP-Relative Addressing and Kernel Payloads</a></li>
                  
                    <li><a href="/posts/2012/02/resolving-kernel-symbols/">Resolving kernel symbols</a></li>
                  
                    <li><a href="/posts/2012/02/carving-up-efi-fat-binaries/">Carving up EFI fat binaries</a></li>
                  
                    <li><a href="/posts/2012/02/vmware-hardware-debugging/">VMware debugging II&#58; "Hardware" debugging</a></li>
                  
                    <li><a href="/posts/2012/02/debugging-the-mac-os-x-kernel-with-vmware-and-gdb/">Debugging the Mac OS X kernel with VMware and GDB</a></li>
                  
                </ul>
                <h2>SEARCH</h2>
                <form method="get" action="http://www.google.com/search">
                  <fieldset>
                    <input type="hidden" name="sitesearch" value="ho.ax"/>
                    <input type="text" class="searchbox" name="q" size="31" maxlength="255" value=""/>
                    <input type="image" class="searchbutton" width=24 height=24 src="/img/search.png" value="Search"/>
                  </fieldset>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="splitbar">&nbsp;</div>
      <div id="footer">
          <div class="container_12">
            <div class="grid_9">
              <p>Last updated on 9 May 2015 by snare. Please don't steal my stuff.</p>
            </div>
            <div class="grid_3">
              <div class="media">
                <div style="float: left"><a class="twitter" href="http://twitter.com/snare"></a></div>
                <div style="float: left"><a class="rss" href="/feed.xml"></a></div>
              </div>
            </div>
        </div>
      </div>
    </div>
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-29183428-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

  </script>
  <img src="/img/twitter_active.png" style="display: none" />
  <img src="/img/rss_active.png" style="display: none" />
  </body>
</html>
